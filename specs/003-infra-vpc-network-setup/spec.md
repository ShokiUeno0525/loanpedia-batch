# Feature Specification: VPCネットワーク基盤の構築

**Feature Branch**: `003-infra-vpc-network-setup`
**Created**: 2025-11-18
**Status**: Draft
**Input**: User description: "VPCネットワーク基盤の構築 - シングルAZ構成でVPC、パブリックサブネット、プライベートサブネット、アイソレートサブネットを作成"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基本ネットワークインフラの構築 (Priority: P1)

インフラ管理者として、アプリケーションをデプロイするための基礎となるVPCとサブネット構成を作成し、各リソースが適切なネットワークセグメントに配置できる環境を整える。

**Why this priority**: システム全体の基盤となるネットワーク構成であり、すべてのアプリケーションリソースのデプロイに必須。これがなければ他の機能開発が進められない。

**Independent Test**: AWS Console または CLI で VPC とサブネットが作成されていることを確認し、CIDR ブロックが仕様通りに設定されていることを検証できる。

**Acceptance Scenarios**:

1. **Given** AWS アカウントにログインした状態で、**When** VPC を確認すると、**Then** CIDR 10.16.0.0/16 の VPC が存在する
2. **Given** VPC が作成された状態で、**When** サブネット一覧を確認すると、**Then** 3つのサブネット（パブリック、プライベート、アイソレート）が存在する
3. **Given** 各サブネットが作成された状態で、**When** CIDR ブロックを確認すると、**Then** パブリック: 10.16.0.0/20、プライベート: 10.16.32.0/20、アイソレート: 10.16.64.0/20 が設定されている

---

### User Story 2 - インターネット接続の確立 (Priority: P2)

インフラ管理者として、パブリックサブネットからインターネットへの双方向通信を可能にし、外部からのアクセスを受け付けるリソース（将来的な ALB など）を配置できる環境を構築する。

**Why this priority**: VPC の基本構成（P1）の次に必要な要素。パブリックサブネットにインターネット接続がなければ、外部からのアクセスを受け付けることができない。

**Independent Test**: パブリックサブネットに EC2 インスタンス（パブリック IP 付き）を起動し、インターネットからの ping や HTTP アクセスが成功することを確認できる。

**Acceptance Scenarios**:

1. **Given** VPC が作成された状態で、**When** Internet Gateway を確認すると、**Then** VPC にアタッチされた Internet Gateway が存在する
2. **Given** パブリックサブネットのルートテーブルを確認した際に、**When** ルートエントリを見ると、**Then** 0.0.0.0/0 → Internet Gateway のルートが存在する
3. **Given** パブリックサブネットにパブリック IP を持つリソースを配置した際に、**When** インターネットから接続を試みると、**Then** 接続が成功する

---

### User Story 3 - プライベートリソースのインターネットアクセス確立 (Priority: P3)

インフラ管理者として、プライベートサブネットに配置される ECS や Lambda がインターネット（外部 API、パッケージリポジトリなど）にアクセスできるよう、NAT Gateway を経由した外向き通信を実現する。

**Why this priority**: P1, P2 の基盤構成が完了した後に必要な機能。ECS や Lambda が外部 API やサービスと通信するために必須。

**Independent Test**: プライベートサブネットに EC2 インスタンス（パブリック IP なし）を起動し、NAT Gateway 経由で外部インターネットへの HTTP リクエストが成功することを確認できる。

**Acceptance Scenarios**:

1. **Given** パブリックサブネットが作成された状態で、**When** NAT Gateway を確認すると、**Then** パブリックサブネットに NAT Gateway が配置されている
2. **Given** NAT Gateway が配置された状態で、**When** NAT Gateway に Elastic IP が割り当てられているか確認すると、**Then** Elastic IP が関連付けられている
3. **Given** プライベートサブネットのルートテーブルを確認した際に、**When** ルートエントリを見ると、**Then** 0.0.0.0/0 → NAT Gateway のルートが存在する
4. **Given** プライベートサブネットにリソースを配置した際に、**When** インターネットへの外向き通信を試みると、**Then** NAT Gateway 経由で通信が成功する

---

### User Story 4 - データベースの完全隔離環境の構築 (Priority: P4)

インフラ管理者として、RDS などの機密性の高いデータベースリソースを外部通信から完全に隔離し、VPC 内の他のリソース（Lambda、ECS）からのみアクセス可能な環境を構築する。

**Why this priority**: セキュリティのベストプラクティスだが、アプリケーション動作には直接影響しない。P3 までが完了すればアプリケーションは稼働可能。

**Independent Test**: アイソレートサブネットに RDS インスタンスを配置し、プライベートサブネットの Lambda から接続できること、インターネットへの外向き通信ができないことを確認できる。

**Acceptance Scenarios**:

1. **Given** アイソレートサブネットが作成された状態で、**When** ルートテーブルを確認すると、**Then** インターネットや NAT Gateway へのルートが存在しない
2. **Given** アイソレートサブネットにルートテーブルが関連付けられた状態で、**When** ルートエントリを確認すると、**Then** VPC 内のローカル通信（10.16.0.0/16）のみが許可されている
3. **Given** アイソレートサブネットに RDS を配置した際に、**When** プライベートサブネットの Lambda から接続を試みると、**Then** 接続が成功する
4. **Given** アイソレートサブネットに RDS を配置した際に、**When** インターネットへの外向き通信を試みると、**Then** 通信が失敗する

---

### Edge Cases

- **CIDR ブロックの重複**: 既存 VPC や将来的なピアリング接続で CIDR ブロックが重複した場合、ルーティングが競合する可能性がある
- **NAT Gateway の障害**: 単一 NAT Gateway のため、障害時はプライベートサブネットからのインターネット通信が完全に停止する
- **Elastic IP の枯渇**: NAT Gateway に割り当てる Elastic IP が利用可能な上限に達している場合、作成が失敗する
- **サブネット CIDR の拡張不可**: 一度作成したサブネットの CIDR ブロックは変更できないため、将来的な IP アドレス不足に対応できない
- **AZ 障害**: シングル AZ 構成のため、AZ 全体の障害時にすべてのリソースが利用不可能になる

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは CIDR ブロック 10.16.0.0/16 の VPC を作成しなければならない
- **FR-002**: システムは VPC に Internet Gateway をアタッチしなければならない
- **FR-003**: システムは CIDR ブロック 10.16.0.0/20 のパブリックサブネットを作成しなければならない
- **FR-004**: システムは CIDR ブロック 10.16.32.0/20 のプライベートサブネットを作成しなければならない
- **FR-005**: システムは CIDR ブロック 10.16.64.0/20 のアイソレートサブネットを作成しなければならない
- **FR-006**: システムはパブリックサブネットに NAT Gateway を配置しなければならない
- **FR-007**: システムは NAT Gateway に Elastic IP を割り当てなければならない
- **FR-008**: システムはパブリックサブネット用のルートテーブルを作成し、0.0.0.0/0 → Internet Gateway のルートを設定しなければならない
- **FR-009**: システムはプライベートサブネット用のルートテーブルを作成し、0.0.0.0/0 → NAT Gateway のルートを設定しなければならない
- **FR-010**: システムはアイソレートサブネット用のルートテーブルを作成し、外部通信へのルートを設定してはならない（VPC ローカル通信のみ）
- **FR-011**: システムは各サブネットを単一の Availability Zone に配置しなければならない（シングル AZ 構成）
- **FR-012**: システムはパブリックサブネットで「パブリック IP の自動割り当て」を有効化しなければならない
- **FR-013**: システムは各ネットワークリソースに識別可能な名前タグを付与しなければならない

### Key Entities

- **VPC**: アプリケーション全体を収容する仮想ネットワーク空間。CIDR ブロック 10.16.0.0/16、最大 65,536 個の IP アドレスを提供
- **パブリックサブネット**: インターネットからの直接アクセスを受け付けるリソース（将来的な ALB など）を配置。CIDR 10.16.0.0/20、4,096 個の IP アドレス
- **プライベートサブネット**: ECS や Lambda など、外部からの直接アクセスを受けないがインターネットへの外向き通信が必要なリソースを配置。CIDR 10.16.32.0/20、4,096 個の IP アドレス
- **アイソレートサブネット**: RDS など、外部通信が不要で VPC 内通信のみを行うリソースを配置。CIDR 10.16.64.0/20、4,096 個の IP アドレス
- **Internet Gateway**: VPC とインターネット間の双方向通信を可能にするゲートウェイ。パブリックサブネットからのインターネットアクセスに使用
- **NAT Gateway**: プライベートサブネットからインターネットへの外向き通信を可能にする。戻りトラフィックは許可するが、インターネットからの新規接続は拒否
- **ルートテーブル**: サブネットレベルでトラフィックの経路を制御。各サブネットタイプごとに異なるルーティングルールを適用

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: VPC とすべてのサブネットが仕様通りの CIDR ブロックで作成され、AWS Console または CLI で確認できる
- **SC-002**: パブリックサブネットに配置したリソースがインターネットからアクセス可能であり、接続成功率が 100% である
- **SC-003**: プライベートサブネットに配置したリソースが NAT Gateway 経由でインターネットにアクセスでき、外部 API 呼び出しが成功する
- **SC-004**: アイソレートサブネットに配置したリソースがインターネットへのアクセスを持たず、外向き通信が 100% 失敗する
- **SC-005**: アイソレートサブネットと プライベートサブネット間で VPC 内通信が可能であり、接続成功率が 100% である
- **SC-006**: 各サブネットが正しいルートテーブルに関連付けられ、トラフィックが意図した経路を通ることが traceroute または VPC Flow Logs で確認できる
- **SC-007**: ネットワーク構成のデプロイが 10 分以内に完了する

## Assumptions

- **仮定-001**: 本番環境ではなく開発・検証環境であるため、シングル AZ 構成で可用性要件を満たす
- **仮定-002**: 将来的に ALB をパブリックサブネットに配置する予定だが、本フェーズでは作成しない
- **仮定-003**: ECS、Lambda、RDS は本フェーズでは作成せず、サブネット構成のみを準備する
- **仮定-004**: NAT Gateway は 1 個のみ配置し、コスト最適化を優先する（高可用性は求めない）
- **仮定-005**: VPC フローログやネットワーク ACL は本フェーズでは設定せず、基本的なルーティング構成のみを実装する
- **仮定-006**: AWS CDK (TypeScript) を使用してインフラをコード化し、再現可能な構成を実現する
- **仮定-007**: CIDR ブロックの IP アドレス数（各サブネット 4,096 個）は将来的な拡張に十分である

## Dependencies

- **依存-001**: AWS アカウントが有効で、VPC 作成の権限を持つ IAM ユーザー/ロールが利用可能であること
- **依存-002**: AWS リージョンに Elastic IP の利用可能な割り当て枠が存在すること（NAT Gateway 用）
- **依存-003**: AWS CDK がインストールされ、デプロイ環境が整っていること

## Out of Scope

- **範囲外-001**: マルチ AZ 構成による高可用性の実現
- **範囲外-002**: VPC フローログの有効化とログ分析
- **範囲外-003**: ネットワーク ACL によるサブネットレベルのファイアウォール設定
- **範囲外-004**: VPC ピアリングや Transit Gateway による他 VPC との接続
- **範囲外-005**: VPC エンドポイント（S3、DynamoDB など）の設定によるコスト最適化
- **範囲外-006**: Application Load Balancer (ALB) の作成と配置
- **範囲外-007**: ECS、Lambda、RDS などのアプリケーションリソースの作成
