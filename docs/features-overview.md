# 機能概要

本ドキュメントは、Loanpedia Batch Processing Systemの全機能を概要レベルで整理したものです。各機能の詳細仕様は、実装フェーズで `/speckit.specify` により作成されます。

## 機能一覧と優先順位

| 優先度 | 機能ID | 機能名 | 概要 | 依存関係 |
|--------|--------|--------|------|----------|
| P1 | F01 | データ収集・処理機能 | 金融機関サイトからスクレイピング → AI処理 → DB保存 | なし |
| P2 | F02 | ユーザー管理機能 | アカウント作成、認証、メール・パスワード管理 | F01 |
| P3 | F03 | 検索・閲覧機能 | ローン商品の検索、一覧、詳細表示 | F01, F02 |
| P4 | F04 | お気に入り機能 | お気に入り登録・一覧表示・削除 | F02, F03 |

---

## F01: データ収集・処理機能

### 目的
4つの金融機関のWebサイトから公開されているローン情報を自動収集し、AI処理を経てデータベースに保存する一気通貫のバッチ処理パイプライン。

### 処理フロー

```
金融機関サイト
    ↓ スクレイピング
raw_loan_data（生データ）
    ↓ AI処理（BedRock API）
processed_loan_data（処理済み）
    ↓ データ統合
loan_products（統合データ）
```

### 主な機能

#### 1. データ収集（スクレイピング）
- **対象サイトのクロール**: robots.txtを遵守し、適切な間隔でアクセス
- **HTMLデータの取得**: ローン商品ページのHTMLを取得
- **構造化データの抽出**: 商品名、金利、融資額、返済期間などを抽出
- **重複チェック**: content_hashによる重複データの検出
- **エラーハンドリング**: リトライ機構、ログ記録

#### 2. AI処理
- **テキスト抽出**: HTMLから本文テキストを抽出
- **構造化データ生成**: Amazon Titan Text LiteでJSON形式に変換
- **要約生成**: ユーザーにわかりやすい要約文を生成
- **データ検証**: JSONスキーマ検証
- **エラーハンドリング**: レート制限対応、失敗時の元データ保持

#### 3. データ保存
- **段階的保存**: 生データ、処理済み、統合データを各テーブルに保存
- **処理状態管理**: pending/processing/completed/failedの状態遷移
- **メタデータ記録**: URL、取得日時、プロンプトバージョン等

### 対象金融機関
1. 青森みちのく銀行（0117）
2. 青い森信用金庫（1250）
3. 東奥信用金庫（1251）
4. 青森県信用組合（2260）

### 技術要件
- **言語**: Python 3.12+
- **ライブラリ**: BeautifulSoup4, requests
- **AI API**: Amazon BedRock API（Amazon Titan Text Lite）
  - 入力コスト: $0.0003/1K tokens
  - 出力コスト: $0.0004/1K tokens
  - 月間想定コスト: 約$0.10（120商品）
- **データベース**: MySQL 8.0+
- **実行頻度**: 月次バッチ処理
- **スクレイピングマナー**:
  - リクエスト間隔: 最低3秒
  - User-Agent: 連絡先情報を含む
  - 同時接続数: 最大1接続

### データベーステーブル

#### `raw_loan_data`（生データ）
- HTML全文
- 抽出テキスト
- メタデータ（URL、取得日時、content_hash）
- 処理状態（pending/processing/completed/failed）

#### `processed_loan_data`（処理済みデータ）
- AI要約
- 構造化データ（JSON）
- 元データへの参照（raw_loan_data_id）
- 処理日時、プロンプトバージョン

#### `loan_products`（統合データ）
エンドユーザー向けの統合ローン商品情報
- 基本情報: 商品名、商品コード、金融機関、ローン種別
- 金利情報: 最低/最高金利、金利種別
- 融資条件: 融資額範囲、返済期間、返済方法
- 申込要件: 年齢制限、収入条件、保証人要件
- 商品特徴: その他特記事項
- メタ情報: 作成日時、更新日時、データソース

### 非機能要件
- 4金融機関の全ローン情報を6時間以内に収集完了
- AI処理は1商品あたり平均5秒以内
- 処理失敗時は最大3回リトライ（指数バックオフ）
- 処理の冪等性を保証
- レート制限（429エラー）への適切な対応

---

## F02: ユーザー管理機能

### 目的
ユーザーアカウントの作成・管理と認証機能を提供する。最小限の情報（メールアドレス・パスワード）のみで運用。

### 主な機能

#### 1. ユーザー登録
- メールアドレス + パスワードでアカウント作成
- メールアドレス検証（確認メール送信）
- パスワード強度チェック
- 利用規約への同意

#### 2. ログイン/ログアウト
- メールアドレス + パスワード認証
- セッション管理
- ログイン状態の保持（Remember Me機能）

#### 3. アカウント設定
- メールアドレス変更（再認証必須）
- パスワード変更（現在のパスワード確認必須）

#### 4. パスワードリセット
- メールアドレスによるパスワードリセット
- 確認コード送信
- 新パスワードの設定

### 技術要件
- **ユーザー管理**: AWS Cognito
  - ユーザープール管理
  - メールアドレス検証
  - パスワードポリシー設定
  - MFA対応（将来的に）
- **バックエンド**: Python 3.12+ FastAPI
- **認証**: AWS Cognito JWT トークン認証
- **セキュリティ**:
  - Cognitoによるパスワードハッシュ化
  - CORS設定
  - SQL injection対策（SQLAlchemy使用）

### データベーステーブル

本機能ではユーザー情報をCognitoで管理するため、独自のusersテーブルは作成しません。
ユーザーIDはCognitoのsub（UUID）を使用し、他のテーブル（お気に入り、履歴等）で外部キーとして参照します。

### 非機能要件
- ログイン処理は1秒以内
- パスワードは最低8文字、英数字記号混在を推奨

---

## F03: 検索・閲覧機能

### 目的
ユーザーが青森県内のローン商品を検索・閲覧できる機能を提供する。

### 主な機能

#### 1. ローン商品一覧表示
- 全ローン商品の一覧表示（テーブル形式）
- 主要項目を表示：金融機関、商品名、金利、融資額、返済期間
- ページネーション対応
- 金融機関別、ローン種別別の表示

#### 2. 検索機能
- **全文検索**: 商品名、概要での検索
- **条件絞り込み**:
  - 金融機関
  - ローン種別（住宅、車、教育等）
  - 金利範囲（最低〜最高）
  - 融資額範囲
  - 返済期間
- **ソート機能**: 金利順、融資額順、更新日順

#### 3. 詳細表示
- 個別ローン商品の詳細情報表示
- AI要約の表示
- 全ての項目の表示
- 金融機関サイトへのリンク

### 技術要件
- **バックエンド**: FastAPI REST API
- **フロントエンド**: React 18+ TypeScript
- **検索**: MySQL全文検索 + インデックス活用

### 非機能要件
- 検索APIは95パーセンタイルで500ms以内
- データ取得APIは95パーセンタイルで200ms以内
- レスポンシブデザイン対応（PC、タブレット、スマホ）

---

## F04: お気に入り機能

### 目的
ユーザーが気になるローン商品を保存し、後から簡単にアクセスできる機能を提供する。

### 主な機能

#### 1. お気に入り登録
- ローン商品詳細ページからお気に入りに追加
- 一覧ページから直接お気に入りに追加
- お気に入り登録済みの視覚的な表示

#### 2. お気に入り一覧表示
- お気に入りに登録した商品の一覧を表示
- 登録日時順でソート
- 一覧から詳細ページへ遷移可能

#### 3. お気に入り削除
- お気に入りから削除
- 一覧ページと詳細ページの両方から削除可能

### データベーステーブル

#### `user_favorites`
- `id`: 主キー
- `user_id`: ユーザーID（Cognito sub）
- `loan_product_id`: 商品ID（loan_productsへの外部キー）
- `created_at`: 登録日時

### 技術要件
- **バックエンド**: FastAPI
- **フロントエンド**: React TypeScript

### 非機能要件
- お気に入り登録・削除は即座に反映（1秒以内）
- ユーザーあたりのお気に入り登録数制限: 100件

---

## 機能間の依存関係

```
F01 (データ収集・処理)
  ├─ スクレイピング
  ├─ AI処理
  └─ データ保存
     ↓
F02 (ユーザー管理) ──┐
     ↓               │
F03 (検索・閲覧) ────┘
     ↓
F04 (お気に入り機能)
```

### 実装順序の理由

1. **F01**: データがないとシステムが動かない（最優先）
2. **F02**: 認証基盤が必要（ユーザー向け機能の前提）
3. **F03**: メイン機能（検索・閲覧）
4. **F04**: 付加価値機能（お気に入り保存）
