# Loanpedia Batch Processing System 憲章

## コア原則

### I. 日本語優先

全ての仕様書、計画書、タスクリスト、ドキュメント、およびユーザーとのコミュニケーションは**日本語で記述すること**。

**必須要件**:
- 仕様書（spec.md）は日本語で記述すること
- 計画書（plan.md）は日本語で記述すること
- タスクリスト（tasks.md）は日本語で記述すること
- コミットメッセージは日本語で記述すること
- ユーザーとの対話は日本語で行うこと
- コード内のコメントは日本語で記述すること

**例外**:
- プログラミング言語のキーワード、変数名、関数名は英語
- 技術用語で適切な日本語訳が存在しない場合は英語表記を使用可
- 外部ライブラリやAPIのドキュメント引用は原文のまま

**理由**: プロジェクトチームの主要言語が日本語であり、仕様の理解とコミュニケーションの正確性を最大化するため。

### II. バッチ処理の信頼性

バッチ処理は月次で実行され、データ収集の基盤となる。処理の失敗はシステム全体に影響するため、以下を厳守すること。

**必須要件**:
- 全てのバッチ処理にエラーハンドリングを実装すること
- リトライメカニズムを実装すること（最大3回、指数バックオフ）
- 処理状況を適切にログに記録すること
- 処理の冪等性を保証すること（同じ処理を複数回実行しても結果が同じ）

**理由**: 月次実行という特性上、失敗時の再実行コストが高く、データ収集の遅延が業務に直接影響するため。

### III. データ品質の保証

収集データの品質は、AI処理とエンドユーザー体験に直結する。

**必須要件**:
- データ収集時に必ずスキーマ検証を実行すること
- 重複データを`content_hash`により検出・防止すること
- 収集元URL、収集日時などのメタデータを必ず記録すること
- データ変換・正規化のロジックは単体テスト必須

**理由**: 不正確なデータはAI処理の精度低下とユーザーへの誤情報提供につながり、システムの信頼性を損なうため。

### IV. AI処理の透明性

BedRock APIを使用したAI処理は、結果の検証可能性を確保すること。

**必須要件**:
- AI処理の入力（元データ）と出力（要約・構造化データ）を両方保存すること
- プロンプトとモデルバージョンをログに記録すること
- AI処理失敗時は元データを保持し、手動レビューを可能にすること
- レート制限に適切に対応すること（429エラーのハンドリング）

**理由**: AI処理は非決定的であり、結果の検証と改善のためには処理の完全なトレーサビリティが不可欠であるため。

### V. セキュリティ基本原則

ソフトウェア開発の基本として、セキュリティベストプラクティスを遵守すること。

**必須要件**:
- API キー、データベース認証情報などの機密情報は`.env`で管理し、リポジトリにコミットしないこと
- `.gitignore`で機密ファイルを確実に除外すること
- データベースアクセスは最小権限の原則に従うこと
- ログ出力時は機密情報をマスキングすること

**理由**: セキュリティは全てのソフトウェアの基本要件であり、脆弱性は後から修正するコストが高いため、開発初期から徹底する。

### VI. スクレイピングマナーと倫理

金融機関のWebサイトから情報を収集する際は、相手サーバーに配慮し、法的・倫理的な基準を遵守すること。

**必須要件**:
- `robots.txt`を確認し、クロール禁止の指定がある場合は従うこと
- リクエスト間隔を適切に設定すること（最低3秒以上の間隔を推奨）
- User-Agentヘッダーに連絡先情報を含めること（例: `Loanpedia/1.0 (+https://example.com/contact)`）
- 同一サイトへの同時接続数を制限すること（最大1接続）
- サーバーエラー（5xx）発生時は即座にリトライせず、十分な待機時間を設けること
- 収集するのは公開情報のみとし、ログイン認証が必要なページはスクレイピングしないこと

**禁止事項**:
- サーバーに過度な負荷をかける高頻度アクセス
- 利用規約で明示的に禁止されているスクレイピング
- 個人情報や非公開情報の収集
- User-Agentを偽装してブラウザのふりをすること

**理由**: 相手サーバーへの配慮を欠いた行動は、サービス妨害や法的問題につながる可能性があり、データ提供元との信頼関係を損なうため。

### VII. 段階的データ保存

データ処理の各段階を独立したテーブルに保存し、トレーサビリティを確保すること。

**必須要件**:
- 生データ（`raw_loan_data`）: HTMLと抽出テキストを保存
- 処理済みデータ（`processed_loan_data`）: AI要約と構造化データを保存
- 統合データ（`loan_products`）: エンドユーザー向けデータを保存
- 各段階で処理状態（pending/processing/completed/failed）を記録すること

**理由**: 処理の途中段階を保存することで、エラー時の復旧が容易になり、データの流れを追跡できるため。

## 開発プラクティス

### Git運用ルール

**ブランチ戦略**:
- `main`: プロダクション用の安定ブランチ
- `feature/*`: 機能開発用ブランチ
- `bugfix/*`: バグ修正用ブランチ
- `hotfix/*`: 緊急修正用ブランチ

**コミットメッセージ規約**:
```
種別: 概要（50文字以内）

詳細説明（必要に応じて）
- 変更内容の詳細
- 変更理由
- 影響範囲
```

**種別**: feat（新機能）、fix（バグ修正）、docs（ドキュメント）、refactor（リファクタリング）、test（テスト）

**禁止事項**:
- `main`ブランチへの直接プッシュ
- 強制プッシュ（`git push --force`）
- 機密情報のコミット
- 大量のファイル変更を含む単一コミット

### コードレビュー要件

**プルリクエスト作成時**:
- テストが全て通過していること
- 関連ドキュメントが更新されていること
- 変更概要、変更理由、テスト方法、影響範囲を明記すること

**レビュー観点**:
- コア原則への準拠（特にデータ品質、セキュリティ、AI処理の透明性、スクレイピングマナー）
- エラーハンドリングの適切性
- ログ出力の十分性
- テストカバレッジ

## 技術制約

### 技術スタック

**バッチ処理**: Python 3.12+
- Web スクレイピング: BeautifulSoup4, requests
- スケジュール: EventBridge または Cron
- エラーハンドリング: リトライ機構 + CloudWatch

**AI処理**: Amazon BedRock API
- Claude 3 モデル使用
- JSON スキーマ検証必須
- レートリミット対応必須

**データベース**: MySQL 8.0+
- フルテキスト検索対応
- JSON カラム活用
- インデックス最適化

**API**: PHP 8.2+ + Laravel 10+
**フロントエンド**: React 18+ + JavaScript

### パフォーマンス要件

**バッチ処理**:
- 4金融機関の全ローン情報を6時間以内に収集完了すること
- AI処理は1商品あたり平均5秒以内
- 処理失敗時のリトライは指数バックオフで実施
- スクレイピング時のリクエスト間隔は最低3秒

**API応答**:
- 検索APIは95パーセンタイルで500ms以内
- データ取得APIは95パーセンタイルで200ms以内

## ガバナンス

### 憲章の優先順位

本憲章は全ての開発プラクティスに優先する。憲章に記載された原則と他のガイドラインが矛盾する場合、憲章が優先される。

### 改定手順

憲章の改定には以下が必要:
1. 改定提案の文書化（背景、理由、影響範囲）
2. チームメンバーの承認
3. 関連ドキュメント（plan-template.md、spec-template.md等）の更新
4. バージョン番号の更新（セマンティックバージョニング）

### コンプライアンス検証

**全てのPR/レビューで以下を確認すること**:
- コア原則への準拠
- 必須要件の充足
- 複雑性の正当化（複雑な設計が必要な場合、その理由を明示）

**定期レビュー**:
- 四半期ごとに憲章の有効性をレビュー
- プロジェクトの成長に応じて原則を更新

### ランタイム開発ガイダンス

日常の開発では`CLAUDE.md`を参照すること。`CLAUDE.md`は本憲章の原則を実装レベルに落とし込んだガイダンスを提供する。

**Version**: 1.0.0 | **Ratified**: 2025-11-12 | **Last Amended**: 2025-11-12
